<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>互動手寫板 - 多班級版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JSZip for Download Packaging -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FFF8E1;
            overscroll-behavior: none;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #FFB74D; border-radius: 4px; }
        .btn-bounce:active { transform: scale(0.95); }
        .canvas-container {
            background-image: radial-gradient(#ddd 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: crosshair;
            touch-action: none;
        }
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF9800;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        .loader.\!w-4.\!h-4 {
            width: 1rem; height: 1rem; border-width: 2px; margin-right: 0.5rem; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .role-btn { aspect-ratio: 1 / 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .page-indicator { background: rgba(255, 255, 255, 0.9); border: 1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="text-gray-700 h-screen overflow-hidden flex flex-col">

    <!-- 全局變數與設定 -->
    <script>
        const hardcodedConfig = {
            //把以下六行有demo的設定值取代為申請好的firebase設定值即可
  apiKey: "AIzaSyC2uPMXlHHldKpeb0br8jY5dOadQLGmHfc",
  authDomain: "handwrite-c39fe.firebaseapp.com",
  projectId: "handwrite-c39fe",
  storageBucket: "handwrite-c39fe.firebasestorage.app",
  messagingSenderId: "728494695338",
  appId: "1:728494695338:web:6dafc09c224f8d01c541d3"
        }; 
        
        let db = null;
        let auth = null;
        let currentUser = null;
        let currentRole = null; 
        let currentAppId = 'classroom-app-v2'; // 更新版本以區隔舊資料
        let currentClassCode = null; // 新增：目前的班級代碼

        // 畫布變數
        let isDrawing = false;
        let ctx = null;
        let points = [];
        let currentStroke = [];
        let penColor = '#333333';
        let penSize = 4;
        let isEraser = false;
        let pages = [{ strokes: [] }];
        let currentPageIndex = 0;
        let showOnionSkin = false;
        let lastResetTrigger = null;

        let replayTimeouts = [];
        let replaySpeed = 1;
        let confirmationCallback = null;
        let teacherSessionUnsubscribe = null; // 用於監聽班級列表

        // 背景圖相關變數
        let backgroundImageData = null; // 學生端儲存的背景圖資料
        let backgroundImageOpacity = 0.5; // 學生端儲存的背景圖透明度
        let backgroundImageObj = null; // 緩存的Image對象
        let isBackgroundImageLoaded = false; // 背景圖是否已載入
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- 頁面：主選單 -->
    <div id="page-lobby" class="flex-1 flex flex-col items-center justify-center p-4 w-full relative bg-[#FFF8E1]">
        <div class="absolute top-4 right-4 flex space-x-3 z-20">
            <button onclick="openHelpModal()" class="w-10 h-10 rounded-full bg-white/80 hover:bg-white shadow-sm text-gray-500 hover:text-orange-500 transition flex items-center justify-center"><i class="fa-regular fa-circle-question text-xl"></i></button>
            <button onclick="openSettingsModal()" class="w-10 h-10 rounded-full bg-white/80 hover:bg-white shadow-sm text-gray-500 hover:text-orange-500 transition flex items-center justify-center"><i class="fa-solid fa-gear text-xl"></i></button>
        </div>
        <div class="text-center mb-8 mt-[-40px]">
            <h1 class="text-4xl md:text-5xl font-bold text-orange-500 mb-3 tracking-wider"><i class="fa-solid fa-paintbrush"></i> 互動手寫板</h1>
            <p class="text-gray-500 text-lg">多班級獨立作業系統</p>
        </div>
        <div class="grid grid-cols-2 gap-8 w-full max-w-2xl px-4">
            <button onclick="selectRole('student')" class="btn-bounce role-btn bg-blue-400 hover:bg-blue-500 text-white rounded-3xl shadow-xl transition group">
                <i class="fa-solid fa-user-graduate text-6xl mb-4 group-hover:scale-110 transition-transform"></i>
                <span class="text-2xl font-bold">學生進入</span>
            </button>
            <button onclick="showTeacherLogin()" class="btn-bounce role-btn bg-orange-400 hover:bg-orange-500 text-white rounded-3xl shadow-xl transition group">
                <i class="fa-solid fa-chalkboard-user text-6xl mb-4 group-hover:scale-110 transition-transform"></i>
                <span class="text-2xl font-bold">教師登入</span>
            </button>
        </div>
        
        <!-- 連線資訊顯示區 -->
        <div id="connection-info" class="mt-6 text-sm text-gray-400 font-mono hidden bg-white/50 px-3 py-1 rounded-full border border-white/60">
            <i class="fa-solid fa-circle-check text-green-500 mr-1"></i> 已連線至: <span id="project-id-display" class="font-bold text-gray-600"></span>
        </div>

        <div class="absolute bottom-6 text-center w-full px-4 text-xs text-gray-400">
            Made by <a href="https://kentxchang.blogspot.tw" target="_blank" class="text-orange-600 hover:text-orange-700 underline">阿剛老師</a>
            <p class="mt-1">本作品依據 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW" target="_blank" class="text-blue-600 hover:text-blue-700 underline">創用 CC 姓名標示-非商業性-相同方式分享 4.0 國際</a> 授權條款釋出。</p>
        </div>
    </div>

    <!-- 頁面：教師登入 -->
    <div id="page-teacher-login" class="hidden flex-1 flex flex-col items-center justify-center p-4 w-full max-w-md mx-auto">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full text-center">
            <h2 class="text-2xl font-bold text-gray-700 mb-6">教師驗證</h2>
            <input type="password" id="teacher-pwd" placeholder="請輸入密碼 (tpet)" 
                   class="w-full bg-gray-100 border-2 border-gray-200 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-orange-400 text-center text-lg">
            <div class="flex space-x-2">
                <button onclick="goHome()" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold">返回</button>
                <button onclick="verifyTeacher()" class="flex-1 py-3 rounded-xl bg-orange-500 text-white font-bold shadow-md">驗證</button>
            </div>
        </div>
    </div>

    <!-- 頁面：教師班級選擇 -->
    <div id="page-teacher-setup" class="hidden flex-1 flex flex-col items-center p-4 w-full bg-gray-50">
        <div class="w-full max-w-4xl mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-700"><i class="fa-solid fa-list-check text-orange-500"></i> 班級管理</h2>
                <div class="flex space-x-3">
                    <button onclick="openShareModal()" class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 shadow-sm transition" title="分享連結">
                        <i class="fa-solid fa-share-nodes text-lg"></i>
                    </button>
                    <button onclick="goHome()" class="flex items-center text-gray-400 hover:text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-100 transition">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> 登出
                    </button>
                </div>
            </div>

            <!-- 開新班級區塊 -->
            <div class="bg-white p-6 rounded-2xl shadow-md mb-8 flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1 w-full">
                    <label class="block text-sm font-bold text-gray-500 mb-1">建立或進入班級</label>
                    <input type="text" id="teacher-class-input" placeholder="請輸入班級代碼 (例如: 101, math_a, today01)" 
                           class="w-full bg-gray-100 border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-orange-400 text-lg">
                </div>
                <button onclick="enterClassAsTeacher()" class="w-full md:w-auto px-8 py-3 rounded-xl bg-orange-500 text-white font-bold shadow-md hover:bg-orange-600 whitespace-nowrap mt-auto h-[54px]">
                    <i class="fa-solid fa-door-open mr-2"></i> 進入班級
                </button>
            </div>

            <!-- 進行中列表 -->
            <h3 class="text-xl font-bold text-gray-600 mb-4 flex items-center">
                <i class="fa-solid fa-clock-rotate-left mr-2"></i> 進行中的班級
                <span class="ml-2 text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full" id="active-session-count">0</span>
            </h3>
            <div id="active-sessions-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 動態生成的卡片 -->
                <div class="text-center py-8 text-gray-400 col-span-full bg-white rounded-xl border border-dashed border-gray-300">
                    載入中...
                </div>
            </div>
        </div>
    </div>

    <!-- 頁面：學生畫布 -->
    <div id="page-student" class="hidden h-full flex flex-col relative bg-gray-50">
        <div class="bg-white shadow-sm p-2 flex justify-between items-center z-10">
            <div class="flex items-center space-x-2">
                <div class="flex flex-col leading-tight">
                    <span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs font-bold w-fit mb-0.5" id="student-class-display">Class</span>
                    <span class="font-bold text-sm text-gray-700" id="student-name-display">Name</span>
                </div>
                <span id="connection-status" class="text-xs text-green-500 hidden md:inline"><i class="fa-solid fa-circle"></i></span>
            </div>
            
            <div class="flex items-center bg-gray-100 rounded-lg p-1 space-x-1">
                <button onclick="changePage(-1)" class="w-10 h-10 rounded bg-white hover:bg-gray-200 flex items-center justify-center text-gray-800 shadow-sm text-xl leading-none pb-1">⬅️</button>
                <span class="text-sm font-bold text-gray-700 px-2 min-w-[3.5rem] text-center" id="page-counter">1/1</span>
                <button onclick="changePage(1)" class="w-10 h-10 rounded bg-white hover:bg-gray-200 flex items-center justify-center text-gray-800 shadow-sm text-xl leading-none pb-1">➡️</button>
            </div>

            <div class="flex items-center space-x-2">
                <button onclick="toggleOnionSkin()" id="btn-onion" class="text-sm px-2 py-1 rounded border border-gray-300 text-gray-400 hover:text-blue-500 hover:border-blue-400 transition"><i class="fa-regular fa-eye"></i></button>
                <button onclick="goHome()" class="text-gray-400 px-2 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>

        <div id="student-waiting" class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center text-center p-8 backdrop-blur-sm hidden">
            <div class="text-6xl mb-4 text-blue-300 animate-bounce"><i class="fa-solid fa-mug-hot"></i></div>
            <h2 class="text-2xl font-bold text-gray-600 mb-2">等待老師開始...</h2>
            <p class="text-gray-400 mb-4">班級代碼: <span id="wait-class-code" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>
            <p class="text-xs text-gray-400">請稍候，活動尚未開始</p>
        </div>

        <div class="flex-1 relative overflow-hidden bg-white canvas-container" id="canvas-wrapper">
            <canvas id="drawing-canvas" class="absolute top-0 left-0 touch-none"></canvas>
            <div class="absolute bottom-4 right-4 text-6xl text-gray-100 font-bold pointer-events-none select-none" id="bg-page-num">1</div>
        </div>

        <div class="bg-white p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex justify-between items-center safe-area-bottom">
            <div class="flex space-x-2 overflow-x-auto pb-1">
                <button onclick="setPen('#333333')" class="w-8 h-8 rounded-full bg-gray-800 border-2 border-white shadow-sm ring-2 ring-gray-200 focus:ring-blue-400 shrink-0"></button>
                <button onclick="setPen('#EF4444')" class="w-8 h-8 rounded-full bg-red-500 border-2 border-white shadow-sm ring-2 ring-gray-200 focus:ring-blue-400 shrink-0"></button>
                <button onclick="setPen('#3B82F6')" class="w-8 h-8 rounded-full bg-blue-500 border-2 border-white shadow-sm ring-2 ring-gray-200 focus:ring-blue-400 shrink-0"></button>
                <div class="w-px h-8 bg-gray-200 mx-2 shrink-0"></div>
                <button onclick="toggleEraser()" id="btn-eraser" class="w-10 h-10 rounded-xl bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 shrink-0"><i class="fa-solid fa-eraser"></i></button>
                <button onclick="clearCanvas()" class="w-10 h-10 rounded-xl bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 shrink-0"><i class="fa-solid fa-trash-can"></i></button>
            </div>
            <button onclick="submitWork()" id="btn-submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center shrink-0 text-sm md:text-base"><i class="fa-solid fa-paper-plane mr-2"></i> 送出</button>
        </div>
    </div>

    <!-- 頁面：教師儀表板 -->
    <div id="page-teacher" class="hidden h-full flex flex-col bg-gray-50">
        <div class="bg-white shadow-sm px-4 py-3 flex justify-between items-center z-10 flex-wrap gap-2">
            <div class="flex items-center">
                <button onclick="showPage('page-teacher-setup')" class="mr-3 text-gray-400 hover:text-orange-500"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="font-bold text-lg text-orange-600 flex items-center">
                    <span class="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-sm mr-2 font-mono" id="teacher-dashboard-class-code">CODE</span>
                    <span>控制台</span>
                </h2>
                <button onclick="openShareModal()" class="ml-3 text-blue-400 hover:text-blue-600" title="分享連結">
                    <i class="fa-solid fa-share-nodes text-lg"></i>
                </button>
            </div>
            <div class="flex items-center space-x-2">
                 <button id="btn-background-image" onclick="openBackgroundImageModal()" class="bg-purple-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:bg-purple-600 flex items-center"><i class="fa-solid fa-image mr-1"></i> 背景圖</button>
                 <button id="btn-download-all" onclick="downloadAllSubmissions()" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-600 flex items-center"><i class="fa-solid fa-download mr-1"></i> 下載</button>
                 <button id="btn-toggle-class" onclick="toggleSession()" class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm"><i class="fa-solid fa-play"></i> 開始</button>
                 <button id="btn-end-class" onclick="clearCurrentClassData()" class="bg-gray-400 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-500 flex items-center"><i class="fa-solid fa-trash mr-1"></i> 清除</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <div id="submissions-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div class="col-span-full text-center py-10 text-gray-400"><i class="fa-solid fa-cloud-arrow-up text-4xl mb-3"></i><p>等待學生送出作品...</p></div>
            </div>
        </div>
    </div>

    <!-- 模態視窗：設定 Firebase -->
    <div id="modal-settings" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl modal-enter max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fa-solid fa-gear text-gray-400 mr-2"></i> 連線設定</h3>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">貼上 Firebase 設定 (key: "value" 格式)</label>
                    <textarea id="config-input" class="w-full h-32 p-3 bg-gray-50 border rounded-xl text-xs font-mono focus:ring-2 focus:ring-orange-300 focus:outline-none" placeholder='apiKey: "AIza...", ...'></textarea>
                </div>
                <!-- 新增：清除按鈕與操作區塊 -->
                <div class="flex justify-between items-center mb-6">
                    <button onclick="clearConfig()" class="px-4 py-2 rounded-lg text-red-500 hover:bg-red-50 border border-red-200 font-bold text-sm">清除設定</button>
                    <div class="flex space-x-2">
                        <button onclick="closeModal('modal-settings')" class="px-4 py-2 rounded-lg text-gray-500 hover:bg-gray-100">取消</button>
                        <button onclick="saveConfig()" class="px-6 py-2 rounded-lg bg-orange-500 text-white font-bold shadow-md hover:bg-orange-600">儲存</button>
                    </div>
                </div>
                
                <hr class="border-gray-100 my-4">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <button onclick="generateShareLink()" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-2 rounded-lg text-sm mb-3">產生分享連結</button>
                    <div id="share-result" class="hidden space-y-3">
                        <input type="text" id="share-url" readonly class="w-full text-xs p-2 border rounded bg-white" onclick="this.select()">
                        <div class="flex justify-center bg-white p-2 rounded-lg shadow-sm w-fit mx-auto"><div id="qrcode"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模態視窗：分享連結 (新) -->
    <div id="modal-share" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl modal-enter p-6 text-center">
            <h3 class="text-xl font-bold mb-4 text-gray-700"><i class="fa-solid fa-share-nodes text-blue-500 mr-2"></i> 分享連結</h3>
            
            <p class="text-xs text-gray-500 mb-2 text-left">點擊網址可選取，或使用複製按鈕</p>
            <div class="mb-4 relative group">
                <input type="text" id="share-modal-url" readonly class="w-full text-xs p-3 border-2 border-blue-100 rounded-xl bg-blue-50 pr-10 text-gray-600 font-mono" onclick="this.select()">
                <button onclick="copyShareUrl()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 p-2 transition" title="複製網址">
                    <i class="fa-regular fa-copy text-lg"></i>
                </button>
            </div>
            
            <div class="flex justify-center bg-white p-3 rounded-xl border-2 border-gray-100 w-fit mx-auto mb-6 shadow-sm">
                <div id="share-modal-qrcode"></div>
            </div>
            
            <button onclick="closeModal('modal-share')" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-300 transition">關閉</button>
        </div>
    </div>

    <!-- 模態視窗：說明 -->
    <div id="modal-help" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl modal-enter p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-orange-600">使用與設定說明</h3>
            
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-2 border-l-4 border-orange-400 pl-2">基本操作</h4>
                <p class="text-sm text-gray-500">1. 學生與老師需使用相同的「班級代碼」才能連線。<br>2. 不同代碼的資料互不干擾。<br>3. 老師可同時管理多個班級代碼。</p>
            </div>

            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-2 border-l-4 border-blue-400 pl-2">如何申請免費 Firebase 資料庫</h4>
                <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                    <li>前往 <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-500 underline">Firebase Console</a> 建立新專案 (Google 帳號免費)。</li>
                    <li>新增應用程式 (Web)，複製 `const firebaseConfig = {...}` 設定值。</li>
                    <li>在左側選單進入 <strong>Firestore Database</strong>，點擊「建立資料庫」。</li>
                    <li>設定安全規則時，請務必選擇 <strong>「測試模式」 (Test mode)</strong>。</li>
                    <li>建立完成後，進入 <strong>[規則] (Rules)</strong> 分頁，將過期日修改為 100 年後：<br>
                        <code class="bg-gray-100 p-1 rounded text-xs block mt-1">allow read, write: if request.time < timestamp.date(2125, 12, 31);</code>
                    </li>
                </ol>
                <p class="text-xs text-red-400 mt-2">* 注意：測試模式預設 30 天後過期，請務必修改日期以長期使用。</p>
            </div>

            <div class="text-center"><button onclick="closeModal('modal-help')" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-700 font-bold hover:bg-gray-300">我知道了</button></div>
        </div>
    </div>

    <!-- 模態視窗：作品檢視與重播 -->
    <div id="modal-replay" class="fixed inset-0 bg-black/90 z-50 hidden flex flex-col justify-center items-center">
        <div class="w-full max-w-6xl p-4 flex flex-col h-full">
            <div class="flex justify-between items-center text-white mb-2">
                <div class="flex items-center space-x-4">
                    <h3 id="replay-title" class="text-xl font-bold">學生作品</h3>
                    <div class="flex items-center bg-gray-700 rounded px-2 py-1 space-x-2" id="replay-page-controls">
                        <button onclick="changeReplayPage(-1)" class="hover:text-orange-400"><i class="fa-solid fa-chevron-left"></i></button>
                        <span class="text-sm font-mono" id="replay-page-indicator">1/1</span>
                        <button onclick="changeReplayPage(1)" class="hover:text-orange-400"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <button onclick="closeReplay()" class="text-2xl hover:text-gray-300"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 rounded-lg relative overflow-hidden flex items-center justify-center bg-gray-900" id="replay-container">
                <canvas id="replay-canvas" class="bg-white shadow-lg" style="max-width: 100%; max-height: 100%; object-fit: contain;"></canvas>
            </div>
            <div class="mt-4 flex justify-between items-center bg-gray-800 p-4 rounded-xl text-white">
                <div class="flex items-center space-x-4">
                    <button onclick="playStrokes()" class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center hover:bg-green-600"><i class="fa-solid fa-rotate-right"></i></button>
                    <div class="text-sm">
                        <span class="text-gray-400">速度:</span>
                        <select id="replay-speed" class="bg-gray-700 border-none rounded px-2 py-1 ml-1" onchange="updateSpeed()">
                            <option value="1">1x</option><option value="2">2x</option><option value="4">4x</option>
                        </select>
                    </div>
                </div>
                <div id="replay-status" class="text-sm text-gray-400">就緒</div>
            </div>
        </div>
    </div>

    <!-- 模態視窗：學生登入 (新增班級代碼輸入) -->
    <div id="modal-name" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 text-center">
            <h3 class="text-xl font-bold mb-4 text-orange-600">加入班級</h3>
            <div class="space-y-3 mb-6">
                 <input type="text" id="student-class-input" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-center text-lg focus:outline-none focus:border-blue-400 font-mono" placeholder="班級代碼 (例如: 123)">
                 <input type="text" id="student-name-input" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-center text-lg focus:outline-none focus:border-blue-400" placeholder="你的名字">
            </div>
            <button onclick="startStudentSession()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-600">開始畫畫</button>
        </div>
    </div>
    
    <!-- 模態視窗:背景圖設定 -->
    <div id="modal-background-image" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl modal-enter p-6">
            <h3 class="text-xl font-bold mb-4 text-purple-600 flex items-center">
                <i class="fa-solid fa-image mr-2"></i> 學生畫布第一頁背景圖設定
            </h3>

            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">上傳圖片</label>
                <input type="file" id="background-image-input" accept="image/*" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-400 text-sm">
                <p class="text-xs text-gray-400 mt-1">建議使用適合畫布尺寸的圖片，或使用 <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Ctrl+V</kbd> 貼上圖片</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    透明度: <span id="opacity-value" class="text-purple-600">50%</span>
                </label>
                <input type="range" id="background-opacity-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <div id="background-preview-container" class="mb-4 hidden">
                <label class="block text-sm font-bold text-gray-700 mb-2">預覽</label>
                <div class="border-2 border-gray-200 rounded-xl p-2 bg-gray-50 flex items-center justify-center" style="min-height: 200px;">
                    <img id="background-preview-img" src="" alt="預覽" class="max-w-full max-h-64 object-contain">
                </div>
            </div>

            <div class="flex space-x-2">
                <button onclick="removeBackgroundImage()" class="px-4 py-2 rounded-xl text-red-500 hover:bg-red-50 border border-red-200 font-bold text-sm">移除背景</button>
                <button onclick="closeBackgroundImageModal()" class="flex-1 px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 border border-gray-200">取消</button>
                <button onclick="saveBackgroundImage()" class="flex-1 px-6 py-2 rounded-xl bg-purple-500 text-white font-bold shadow-md hover:bg-purple-600">儲存</button>
            </div>
        </div>
    </div>

    <!-- Generic Action Modal -->
    <div id="modal-action" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl modal-enter p-6 text-center">
            <h3 id="modal-action-title" class="text-xl font-bold mb-4 text-gray-700">提示</h3>
            <p id="modal-action-message" class="text-gray-600 mb-6"></p>
            <div id="modal-action-buttons" class="flex justify-center space-x-3"></div>
        </div>
    </div>

    <!-- 系統核心邏輯 -->
    <script>
        // --- 通用工具 ---
        function showSystemMessage(message, title = "提示") {
            const modal = document.getElementById('modal-action');
            document.getElementById('modal-action-title').innerText = title;
            document.getElementById('modal-action-message').innerText = message;
            document.getElementById('modal-action-buttons').innerHTML = `<button onclick="closeModal('modal-action')" class="px-6 py-2 rounded-xl bg-orange-500 text-white font-bold shadow-md hover:bg-orange-600">確定</button>`;
            modal.classList.remove('hidden');
        }

        function showConfirmationModal(message, callback, title = "確認操作") {
            const modal = document.getElementById('modal-action');
            document.getElementById('modal-action-title').innerText = title;
            document.getElementById('modal-action-message').innerText = message;
            confirmationCallback = callback;
            document.getElementById('modal-action-buttons').innerHTML = `
                <button onclick="handleConfirmation(false)" class="px-6 py-2 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300">取消</button>
                <button onclick="handleConfirmation(true)" class="px-6 py-2 rounded-xl bg-red-500 text-white font-bold shadow-md hover:bg-red-600">確認</button>`;
            modal.classList.remove('hidden');
        }

        function handleConfirmation(result) {
            closeModal('modal-action');
            if (confirmationCallback) { confirmationCallback(result); confirmationCallback = null; }
        }

        // --- 1. 初始化與設定 ---
        async function initApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedConfig = urlParams.get('config');
            if (encodedConfig) {
                try {
                    const config = JSON.parse(atob(encodedConfig));
                    if(config && config.apiKey) {
                        localStorage.setItem('firebase_config', JSON.stringify(config));
                        window.history.replaceState({}, document.title, window.location.pathname);
                        window.location.reload(); 
                        return;
                    }
                } catch (e) { showSystemMessage("設定網址無效"); }
            }

            let config = null;
            const stored = localStorage.getItem('firebase_config');
            if (stored) {
                try { config = JSON.parse(stored); console.log("使用網頁儲存設定"); } 
                catch(e) { console.error("設定解析失敗", e); }
            }
            if (!config) { config = hardcodedConfig; console.log("使用原始碼設定"); }

            if (config) {
                try {
                    if (!firebase.apps.length) {
                        app = firebase.initializeApp(config);
                        auth = firebase.auth();
                        db = firebase.firestore();
                        await auth.signInAnonymously();
                        currentUser = auth.currentUser;
                        console.log("Connected", currentUser.uid);
                        
                        // 成功連線後，顯示 Project ID
                        const projectId = config.projectId;
                        if (projectId) {
                            const infoDiv = document.getElementById('connection-info');
                            const pidSpan = document.getElementById('project-id-display');
                            if (infoDiv && pidSpan) {
                                infoDiv.classList.remove('hidden');
                                pidSpan.innerText = projectId;
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    showSystemMessage("Firebase 連線失敗，請檢查設定。");
                }
            }
        }

        // --- 2. 介面控制 ---
        function showPage(pageId) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openHelpModal() { document.getElementById('modal-help').classList.remove('hidden'); }
        function openSettingsModal() { document.getElementById('modal-settings').classList.remove('hidden'); }
        
        // 分享功能相關
        function openShareModal() {
            let url = "";

            // 如果原始碼中的設定正確且已連線，則產生不帶參數的網址
            if (hardcodedConfig.apiKey !== 'demo' && db) {
                url = `${window.location.origin}${window.location.pathname}`;
            } else {
                let currentConfigStr = localStorage.getItem('firebase_config');
                if (!currentConfigStr && hardcodedConfig.apiKey !== 'demo') currentConfigStr = JSON.stringify(hardcodedConfig);
                
                if(!currentConfigStr) { 
                    showSystemMessage("請先設定 Firebase 連線後才能分享", "無法產生連結"); 
                    return; 
                }
                url = `${window.location.origin}${window.location.pathname}?config=${btoa(currentConfigStr)}`;
            }
            
            const modal = document.getElementById('modal-share');
            const input = document.getElementById('share-modal-url');
            const qrContainer = document.getElementById('share-modal-qrcode');
            
            input.value = url;
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {text: url, width: 160, height: 160});
            
            modal.classList.remove('hidden');
        }

        function copyShareUrl() {
            const input = document.getElementById('share-modal-url');
            input.select();
            input.setSelectionRange(0, 99999); // Mobile compatibility
            
            // 嘗試使用現代 API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(input.value).then(() => {
                    const originalIcon = document.querySelector('#modal-share .fa-copy');
                    if(originalIcon) {
                        originalIcon.classList.remove('fa-copy', 'fa-regular');
                        originalIcon.classList.add('fa-check', 'fa-solid', 'text-green-500');
                        setTimeout(() => {
                             originalIcon.classList.add('fa-copy', 'fa-regular');
                             originalIcon.classList.remove('fa-check', 'fa-solid', 'text-green-500');
                        }, 1500);
                    }
                });
            } else {
                // Fallback
                document.execCommand("copy");
                alert("已複製網址！");
            }
        }

        function checkConfig() {
            if (!db) { showSystemMessage("請先設定 Firebase"); openSettingsModal(); return false; }
            return true;
        }
        function goHome() {
            showConfirmationModal("確定要回到主畫面嗎？", (y) => { if(y) location.reload(); });
        }
        function saveConfig() {
            const input = document.getElementById('config-input').value;
            if (input.includes('apiKey')) {
                try {
                    const extract = (k) => (input.match(new RegExp(`${k}\\s*:\\s*["']([^"']+)["']`)) || [])[1];
                    const config = { apiKey: extract('apiKey'), authDomain: extract('authDomain'), projectId: extract('projectId'), appId: extract('appId') };
                    if(config.apiKey) {
                        localStorage.setItem('firebase_config', JSON.stringify(config));
                        window.location.reload();
                    } else throw new Error();
                } catch(e) { showSystemMessage("設定解析失敗"); }
            }
        }
        
        // 新增：清除設定
        function clearConfig() {
            showConfirmationModal("確定要清除所有連線設定嗎？\n(這將還原為預設狀態)", (y) => {
                if(y) {
                    localStorage.removeItem('firebase_config');
                    // 清除後重整網頁，移除網址參數以防又自動載入
                    window.location.href = window.location.pathname; 
                }
            });
        }
        
        function generateShareLink() {
             let url = "";

             // 如果原始碼中的設定正確且已連線，則產生不帶參數的網址
             if (hardcodedConfig.apiKey !== 'demo' && db) {
                 url = `${window.location.origin}${window.location.pathname}`;
             } else {
                 let currentConfigStr = localStorage.getItem('firebase_config');
                 if (!currentConfigStr && hardcodedConfig.apiKey !== 'demo') currentConfigStr = JSON.stringify(hardcodedConfig);
                 if(!currentConfigStr) { showSystemMessage("請先設定 Firebase"); return; }
                 
                 url = `${window.location.origin}${window.location.pathname}?config=${btoa(currentConfigStr)}`;
             }

             document.getElementById('share-result').classList.remove('hidden');
             document.getElementById('share-url').value = url;
             document.getElementById('qrcode').innerHTML = "";
             new QRCode(document.getElementById('qrcode'), {text: url, width: 128, height: 128});
        }

        // --- 4. 學生邏輯 ---
        let studentName = "";

        function selectRole(role) {
            if (!checkConfig()) return;
            currentRole = role;
            if (role === 'student') {
                // 自動填入上次使用的代碼 (Optional UX)
                const lastCode = localStorage.getItem('last_class_code');
                if(lastCode) document.getElementById('student-class-input').value = lastCode;
                document.getElementById('modal-name').classList.remove('hidden');
            }
        }

        function startStudentSession() {
            const classCode = document.getElementById('student-class-input').value.trim();
            const name = document.getElementById('student-name-input').value.trim();
            
            if (!classCode) { showSystemMessage("請輸入班級代碼"); return; }
            if (!name) { showSystemMessage("請輸入名字"); return; }
            
            currentClassCode = classCode;
            studentName = name;
            localStorage.setItem('last_class_code', classCode);

            document.getElementById('student-name-display').innerText = name;
            document.getElementById('student-class-display').innerText = classCode;
            document.getElementById('wait-class-code').innerText = classCode;
            
            closeModal('modal-name');
            showPage('page-student');
            initCanvas();
            listenToClassState();
            updatePageUI();
        }

        // 監聽班級狀態 (獨立路徑)
        function listenToClassState() {
            // Path: public/data/class_controls/{classCode}
            db.collection('artifacts').doc(currentAppId).collection('public').doc('data')
              .collection('class_controls').doc(currentClassCode)
              .onSnapshot(doc => {
                  const data = doc.exists ? doc.data() : { isActive: false };

                  const waiting = document.getElementById('student-waiting');
                  if (data.isActive) {
                      waiting.classList.add('hidden');
                  } else {
                      waiting.classList.remove('hidden');
                      // 清空本地畫布
                      if (pages.length > 1 || (pages.length === 1 && pages[0].strokes.length > 0)) {
                          resetLocalCanvas();
                      }
                  }

                  if (data.resetTrigger) {
                      if (lastResetTrigger && !data.resetTrigger.isEqual(lastResetTrigger)) {
                           resetLocalCanvas();
                      }
                      lastResetTrigger = data.resetTrigger;
                  }

                  // 處理背景圖設定
                  if (data.backgroundImage) {
                      // 如果背景圖改變了,重新載入
                      if (backgroundImageData !== data.backgroundImage) {
                          backgroundImageData = data.backgroundImage;
                          backgroundImageOpacity = data.backgroundOpacity || 0.5;
                          isBackgroundImageLoaded = false;

                          // 載入新的背景圖
                          backgroundImageObj = new Image();
                          backgroundImageObj.onload = function() {
                              isBackgroundImageLoaded = true;
                              redrawCanvas();
                          };
                          backgroundImageObj.src = backgroundImageData;
                      } else {
                          // 只更新透明度
                          backgroundImageOpacity = data.backgroundOpacity || 0.5;
                          redrawCanvas();
                      }
                  } else {
                      backgroundImageData = null;
                      backgroundImageOpacity = 0.5;
                      backgroundImageObj = null;
                      isBackgroundImageLoaded = false;
                      redrawCanvas();
                  }
              });
        }

        function resetLocalCanvas() {
            pages = [{ strokes: [] }];
            currentPageIndex = 0;
            showOnionSkin = false;
            redrawCanvas();
            updatePageUI();
        }

        // --- 多頁管理 & 畫布 (與前版相同) ---
        function updatePageUI() {
            document.getElementById('page-counter').innerText = `頁數 ${currentPageIndex + 1}/${pages.length}`;
            document.getElementById('bg-page-num').innerText = currentPageIndex + 1;
            const onionBtn = document.getElementById('btn-onion');
            if (currentPageIndex > 0) onionBtn.classList.remove('opacity-50', 'pointer-events-none');
            else { onionBtn.classList.add('opacity-50', 'pointer-events-none'); showOnionSkin = false; }
            
            if (showOnionSkin) {
                onionBtn.classList.add('text-blue-500', 'border-blue-400', 'bg-blue-50');
                onionBtn.classList.remove('text-gray-400');
            } else {
                onionBtn.classList.remove('text-blue-500', 'border-blue-400', 'bg-blue-50');
                onionBtn.classList.add('text-gray-400');
            }
        }
        function changePage(delta) {
            const newIndex = currentPageIndex + delta;
            if (newIndex < 0) return;
            if (newIndex >= pages.length) pages.push({ strokes: [] });
            currentPageIndex = newIndex;
            redrawCanvas();
            updatePageUI();
        }
        function toggleOnionSkin() {
            if (currentPageIndex === 0) return;
            showOnionSkin = !showOnionSkin;
            updatePageUI();
            redrawCanvas();
        }
        function initCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            const wrapper = document.getElementById('canvas-wrapper');
            ctx = canvas.getContext('2d');
            function resize() { canvas.width = wrapper.offsetWidth; canvas.height = wrapper.offsetHeight; redrawCanvas(); }
            window.addEventListener('resize', resize);
            resize();

            const start = (e) => {
                if(e.touches && e.touches.length > 1) return;
                isDrawing = true;
                const pos = getPos(e);
                currentStroke = {
                    color: isEraser ? '#ffffff' : penColor,
                    size: isEraser ? 20 : penSize,
                    points: [{x: pos.x, y: pos.y, t: Date.now()}]
                };
                ctx.beginPath(); ctx.moveTo(pos.x, pos.y); ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = currentStroke.color; ctx.lineWidth = currentStroke.size;
            };
            const move = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                currentStroke.points.push({x: pos.x, y: pos.y, t: Date.now()});
                ctx.lineTo(pos.x, pos.y); ctx.stroke();
            };
            const end = () => {
                if (!isDrawing) return;
                isDrawing = false; ctx.closePath();
                if (currentStroke.points.length > 0) {
                    const startTime = currentStroke.points[0].t;
                    const normalizedStroke = { ...currentStroke, points: currentStroke.points.map(p => ({ x: p.x / canvas.width, y: p.y / canvas.height, dt: p.t - startTime })) };
                    pages[currentPageIndex].strokes.push(normalizedStroke);
                }
            };
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive: false}); canvas.addEventListener('touchmove', move, {passive: false}); canvas.addEventListener('touchend', end);
        }
        function drawStrokesToContext(context, strokeData, width, height, alpha = 1.0, colorOverride = null) {
            if (!strokeData) return;
            context.globalAlpha = alpha;
            strokeData.forEach(stroke => {
                if (stroke.points.length < 1) return;
                context.beginPath(); context.lineCap = 'round'; context.lineJoin = 'round'; context.lineWidth = stroke.size;
                context.strokeStyle = colorOverride ? '#cccccc' : stroke.color; 
                const startP = stroke.points[0];
                context.moveTo(startP.x * width, startP.y * height);
                for (let i = 1; i < stroke.points.length; i++) {
                    const p = stroke.points[i]; context.lineTo(p.x * width, p.y * height);
                }
                context.stroke();
            });
            context.globalAlpha = 1.0;
        }
        function redrawCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            if(!ctx) return;
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 繪製背景圖
            if (backgroundImageObj && isBackgroundImageLoaded) {
                const imgWidth = backgroundImageObj.naturalWidth;
                const imgHeight = backgroundImageObj.naturalHeight;
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;

                // 計算縮放比例以最大化顯示圖片同時保持比例
                const scale = Math.min(canvasWidth / imgWidth, canvasHeight / imgHeight);
                const scaledWidth = imgWidth * scale;
                const scaledHeight = imgHeight * scale;

                // 置中顯示
                const x = (canvasWidth - scaledWidth) / 2;
                const y = (canvasHeight - scaledHeight) / 2;

                // 設定透明度並繪製
                // 第一頁使用設定的透明度，其他頁面在洋蔥皮開啟時使用更低的透明度
                let actualOpacity = backgroundImageOpacity;
                if (currentPageIndex > 0) {
                    if (showOnionSkin) {
                        // 其他頁面洋蔥皮開啟時，背景圖透明度降低
                        actualOpacity = backgroundImageOpacity * 0.3;
                    } else {
                        // 其他頁面洋蔥皮關閉時，不顯示背景圖
                        actualOpacity = 0;
                    }
                }

                if (actualOpacity > 0) {
                    ctx.globalAlpha = actualOpacity;
                    ctx.drawImage(backgroundImageObj, x, y, scaledWidth, scaledHeight);
                    ctx.globalAlpha = 1.0;
                }
            }

            if (showOnionSkin && currentPageIndex > 0) drawStrokesToContext(ctx, pages[currentPageIndex - 1].strokes, canvas.width, canvas.height, 0.3, true);
            drawStrokesToContext(ctx, pages[currentPageIndex].strokes, canvas.width, canvas.height, 1.0);
        }
        function getPos(e) {
            const canvas = document.getElementById('drawing-canvas');
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        function setPen(c) { isEraser=false; penColor=c; penSize=4; }
        function toggleEraser() { isEraser=true; }
        function clearCanvas() { showConfirmationModal("確定要清除「本頁」所有筆跡嗎？", (y)=>{ if(y) { pages[currentPageIndex].strokes = []; redrawCanvas(); }}); }

        // --- 送出作品 (新增 classCode 欄位) ---
        async function submitWork() {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerHTML = '<div class="loader w-4 h-4 border-2"></div> 處理中...';

            try {
                const sourceCanvas = document.getElementById('drawing-canvas');
                const maxDim = 800;
                const scale = Math.min(maxDim / sourceCanvas.width, maxDim / sourceCanvas.height, 1);
                const w = sourceCanvas.width * scale;
                const h = sourceCanvas.height * scale;
                const pagesPayload = [];

                for (let i = 0; i < pages.length; i++) {
                    const tempCanvas = document.createElement('canvas'); tempCanvas.width = w; tempCanvas.height = h;
                    const tCtx = tempCanvas.getContext('2d');
                    tCtx.fillStyle = "#ffffff"; tCtx.fillRect(0, 0, w, h);
                    drawStrokesToContext(tCtx, pages[i].strokes, w, h);
                    const base64 = tempCanvas.toDataURL('image/jpeg', 0.6);
                    pagesPayload.push({ image: base64, strokes: JSON.stringify(pages[i].strokes), pageIndex: i });
                }

                const lastPage = pagesPayload[pagesPayload.length - 1];
                
                // 寫入 Submissions (混在一起，但用 classCode 區分)
                await db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('submissions').add({
                    classCode: currentClassCode, // 關鍵欄位
                    name: studentName,
                    uid: currentUser.uid,
                    image: lastPage.image,
                    strokes: lastPage.strokes,
                    pages: pagesPayload,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSystemMessage("全數傳送成功！");

            } catch (e) {
                console.error(e);
                showSystemMessage("傳送失敗: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> 送出';
            }
        }

        // --- 7. 教師邏輯 (重大改版) ---
        function showTeacherLogin() { if (!checkConfig()) return; showPage('page-teacher-login'); }
        
        function verifyTeacher() {
            if (document.getElementById('teacher-pwd').value === 'tpet') {
                currentRole = 'teacher'; 
                showPage('page-teacher-setup'); // 改為進入設定頁面
                initTeacherSetup();
            } else showSystemMessage("密碼錯誤");
        }

        // 教師設定頁面邏輯
        function initTeacherSetup() {
            // 監聽 active_sessions
            const sessionsRef = db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('active_sessions');
            
            if (teacherSessionUnsubscribe) teacherSessionUnsubscribe();

            teacherSessionUnsubscribe = sessionsRef.orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('active-sessions-list');
                const countSpan = document.getElementById('active-session-count');
                list.innerHTML = '';
                countSpan.innerText = snap.size;

                if (snap.empty) {
                    list.innerHTML = `<div class="text-center py-8 text-gray-400 col-span-full border-2 border-dashed rounded-xl">尚無進行中的班級</div>`;
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    const code = doc.id;
                    const createdTime = data.createdAt ? data.createdAt.toDate() : new Date();
                    const now = new Date();
                    const diffMs = now - createdTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    const durationStr = diffMins < 60 ? `${diffMins} 分鐘前` : `${Math.floor(diffMins/60)} 小時前`;

                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 flex justify-between items-center";
                    card.innerHTML = `
                        <div>
                            <div class="font-bold text-lg text-gray-800">${code}</div>
                            <div class="text-xs text-gray-500"><i class="fa-regular fa-clock"></i> 建立於 ${durationStr}</div>
                        </div>
                        <div class="flex space-x-2">
                             <button onclick="deleteClass('${code}')" class="bg-red-100 text-red-500 hover:bg-red-200 px-3 py-2 rounded-lg text-sm font-bold" title="結束並清除"><i class="fa-solid fa-trash"></i></button>
                             <button onclick="enterExistingClass('${code}')" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-4 py-2 rounded-lg text-sm font-bold"><i class="fa-solid fa-arrow-right"></i> 進入</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        async function enterClassAsTeacher() {
            const code = document.getElementById('teacher-class-input').value.trim();
            if(!code) { showSystemMessage("請輸入班級代碼"); return; }
            await joinClassSession(code);
        }

        async function enterExistingClass(code) {
            await joinClassSession(code);
        }

        async function joinClassSession(code) {
            currentClassCode = code;
            
            // 註冊 Session (如果不存在)
            const sessionRef = db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('active_sessions').doc(code);
            const doc = await sessionRef.get();
            if (!doc.exists) {
                await sessionRef.set({
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    teacherUid: currentUser.uid
                });
            }

            // 初始化 Dashboard UI
            document.getElementById('teacher-dashboard-class-code').innerText = code;
            showPage('page-teacher');
            initTeacherDashboard();
        }

        // 刪除特定班級的所有資料
        function deleteClass(code) {
            showConfirmationModal(`確定要刪除班級「${code}」及其所有學生作品嗎？`, async (y) => {
                if(y) {
                    await performClassCleanup(code);
                }
            });
        }

        async function performClassCleanup(code) {
            const batch = db.batch();
            const rootData = db.collection('artifacts').doc(currentAppId).collection('public').doc('data');

            // 1. 刪除 Submissions (需查詢)
            const subsRef = rootData.collection('submissions');
            // 注意: Firestore 在沒有索引時無法進行複合查詢，這裡只用單一 where，然後 batch delete
            const snaps = await subsRef.where('classCode', '==', code).get();
            snaps.forEach(doc => batch.delete(doc.ref));

            // 2. 刪除 Control 狀態 (重置學生端)
            const controlRef = rootData.collection('class_controls').doc(code);
            // 寫入 resetTrigger 讓在線學生被清除，然後稍微延遲後刪除 control doc? 
            // 這裡直接刪除 session，並設定 isActive: false
            batch.set(controlRef, { isActive: false, resetTrigger: firebase.firestore.FieldValue.serverTimestamp() }); // 先通知關閉
            
            // 3. 刪除 Active Session 記錄
            const sessionRef = rootData.collection('active_sessions').doc(code);
            batch.delete(sessionRef);

            await batch.commit();
            
            // 如果剛好刪除了目前所在的班級 (在 Dashboard 內按清除)
            if (currentClassCode === code && document.getElementById('page-teacher').classList.contains('hidden') === false) {
                 // 重新整理頁面或回到列表
                 location.reload();
            }
        }

        // --- 儀表板邏輯 ---
        let isSessionActive = false;
        let unsubscribeSubmissions = null;

        function initTeacherDashboard() {
            // 監聽 Class Control 狀態
            const controlRef = db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('class_controls').doc(currentClassCode);
            controlRef.onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    updateSessionBtn(data.isActive);

                    // 處理背景圖設定（老師端也需要載入背景圖以顯示學生作品）
                    if (data.backgroundImage) {
                        if (backgroundImageData !== data.backgroundImage) {
                            backgroundImageData = data.backgroundImage;
                            backgroundImageOpacity = data.backgroundOpacity || 0.5;
                            isBackgroundImageLoaded = false;

                            // 載入背景圖
                            backgroundImageObj = new Image();
                            backgroundImageObj.onload = function() {
                                isBackgroundImageLoaded = true;
                            };
                            backgroundImageObj.src = backgroundImageData;
                        } else {
                            backgroundImageOpacity = data.backgroundOpacity || 0.5;
                        }
                    } else {
                        backgroundImageData = null;
                        backgroundImageOpacity = 0.5;
                        backgroundImageObj = null;
                        isBackgroundImageLoaded = false;
                    }
                } else {
                    updateSessionBtn(false);
                    // 若 control doc 不存在，自動建立預設值
                    controlRef.set({isActive: false});
                }
            });

            // 監聽作品 (使用 classCode 過濾)
            // 注意：因為沒有複合索引 (classCode + timestamp)，我們只 query classCode，然後在前端排序
            const q = db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('submissions')
                        .where('classCode', '==', currentClassCode);
            
            if(unsubscribeSubmissions) unsubscribeSubmissions();

            unsubscribeSubmissions = q.onSnapshot(snap => {
                const grid = document.getElementById('submissions-grid');
                grid.innerHTML = '';
                if (snap.empty) { grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400"><p>無作品</p></div>`; return; }
                
                // 前端排序 (新 -> 舊)
                const docs = [];
                snap.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                docs.forEach(data => grid.appendChild(createSubmissionCard(data.id, data)));
            });
        }

        function updateSessionBtn(active) {
            isSessionActive = active;
            const btn = document.getElementById('btn-toggle-class');
            btn.innerHTML = active ? '<i class="fa-solid fa-stop"></i> 停止' : '<i class="fa-solid fa-play"></i> 開始';
            btn.className = active ? "bg-red-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm" : "bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm";
        }

        async function toggleSession() {
            isSessionActive = !isSessionActive;
            await db.collection('artifacts').doc(currentAppId).collection('public').doc('data')
                    .collection('class_controls').doc(currentClassCode)
                    .set({isActive: isSessionActive}, {merge:true});
        }

        // 儀表板內的清除按鈕
        async function clearCurrentClassData() {
            showConfirmationModal(`確定要清除班級「${currentClassCode}」的所有作品嗎？\n(此動作不會刪除班級本身)`, async (y)=>{
                if(y) {
                    const batch = db.batch();
                    const subsRef = db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('submissions');
                    const snaps = await subsRef.where('classCode', '==', currentClassCode).get();
                    snaps.forEach(doc => batch.delete(doc.ref));

                    // Reset 訊號
                    const controlRef = db.collection('artifacts').doc(currentAppId).collection('public').doc('data')
                                         .collection('class_controls').doc(currentClassCode);
                    batch.set(controlRef, { isActive: false, resetTrigger: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});

                    await batch.commit();
                }
            });
        }

        function createSubmissionCard(id, data) {
            const pageCount = data.pages ? data.pages.length : 1;
            const div = document.createElement('div');
            div.className = "bg-white p-2 rounded-xl shadow hover:shadow-lg transition cursor-pointer border border-gray-100 relative";
            div.onclick = () => openReplay(data);
            div.innerHTML = `
                <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden mb-2 relative flex items-center justify-center">
                     <img src="${data.image}" class="max-w-full max-h-full object-contain">
                     ${pageCount > 1 ? `<span class="absolute top-1 right-1 bg-black/50 text-white text-xs px-2 py-0.5 rounded-full">${pageCount} 頁</span>` : ''}
                </div>
                <div class="flex justify-between items-center px-1">
                    <span class="font-bold text-gray-700 truncate text-sm">${data.name}</span>
                    <i class="fa-solid fa-play-circle text-orange-400"></i>
                </div>`;
            return div;
        }

        // --- 8. 重播系統 (不變) ---
        let currentReplayData = null;
        let currentReplayPageIndex = 0;
        function openReplay(data) {
            currentReplayData = data;
            if (!currentReplayData.pages) currentReplayData.pages = [{ image: data.image, strokes: data.strokes }];
            currentReplayPageIndex = 0;
            document.getElementById('modal-replay').classList.remove('hidden');
            document.getElementById('replay-title').innerText = `${data.name} 的作品`;
            updateReplayUI(); loadReplayPage(0);
        }
        function updateReplayUI() { document.getElementById('replay-page-indicator').innerText = `${currentReplayPageIndex + 1}/${currentReplayData.pages.length}`; }
        function changeReplayPage(delta) {
            const newIndex = currentReplayPageIndex + delta;
            if (newIndex >= 0 && newIndex < currentReplayData.pages.length) { currentReplayPageIndex = newIndex; updateReplayUI(); loadReplayPage(newIndex); }
        }
        function loadReplayPage(idx) {
            replayTimeouts.forEach(t => clearTimeout(t)); replayTimeouts = [];
            document.getElementById('replay-status').innerText = "就緒";
            const canvas = document.getElementById('replay-canvas');
            const ctx = canvas.getContext('2d');
            const pageData = currentReplayData.pages[idx];
            const img = new Image();
            img.onload = () => {
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                // 先清空畫布
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 如果是第一頁且有背景圖，先繪製背景圖
                if (idx === 0 && backgroundImageObj && isBackgroundImageLoaded) {
                    const imgWidth = backgroundImageObj.naturalWidth;
                    const imgHeight = backgroundImageObj.naturalHeight;
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;

                    // 計算縮放比例
                    const scale = Math.min(canvasWidth / imgWidth, canvasHeight / imgHeight);
                    const scaledWidth = imgWidth * scale;
                    const scaledHeight = imgHeight * scale;

                    // 置中顯示
                    const x = (canvasWidth - scaledWidth) / 2;
                    const y = (canvasHeight - scaledHeight) / 2;

                    // 繪製背景圖
                    ctx.globalAlpha = backgroundImageOpacity;
                    ctx.drawImage(backgroundImageObj, x, y, scaledWidth, scaledHeight);
                    ctx.globalAlpha = 1.0;
                }

                // 繪製學生作品
                ctx.drawImage(img, 0, 0);
            };
            img.src = pageData.image;
        }
        function closeReplay() { document.getElementById('modal-replay').classList.add('hidden'); replayTimeouts.forEach(t => clearTimeout(t)); }
        function updateSpeed() { replaySpeed = parseInt(document.getElementById('replay-speed').value); }
        function playStrokes() {
            if (!currentReplayData) return;
            const pageData = currentReplayData.pages[currentReplayPageIndex];
            if (!pageData.strokes) return;
            replayTimeouts.forEach(t => clearTimeout(t)); replayTimeouts = [];
            const strokes = JSON.parse(pageData.strokes);
            const canvas = document.getElementById('replay-canvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // 清空畫布
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, width, height);

            // 如果是第一頁且有背景圖，先繪製背景圖
            if (currentReplayPageIndex === 0 && backgroundImageObj && isBackgroundImageLoaded) {
                const imgWidth = backgroundImageObj.naturalWidth;
                const imgHeight = backgroundImageObj.naturalHeight;

                // 計算縮放比例
                const scale = Math.min(width / imgWidth, height / imgHeight);
                const scaledWidth = imgWidth * scale;
                const scaledHeight = imgHeight * scale;

                // 置中顯示
                const x = (width - scaledWidth) / 2;
                const y = (height - scaledHeight) / 2;

                // 繪製背景圖
                ctx.globalAlpha = backgroundImageOpacity;
                ctx.drawImage(backgroundImageObj, x, y, scaledWidth, scaledHeight);
                ctx.globalAlpha = 1.0;
            }

            document.getElementById('replay-status').innerText = "播放中...";
            let globalOffset = 0;
            strokes.forEach((stroke, sIdx) => {
                if (stroke.points.length < 2) return;
                for(let i = 1; i < stroke.points.length; i++) {
                    const p1 = stroke.points[i-1]; const p2 = stroke.points[i];
                    let dt = p2.dt - p1.dt; if (dt > 500) dt = 500;
                    const delay = (globalOffset + dt) / replaySpeed; globalOffset += dt;
                    const t = setTimeout(() => {
                        ctx.beginPath(); ctx.moveTo(p1.x * width, p1.y * height); ctx.lineTo(p2.x * width, p2.y * height);
                        ctx.strokeStyle = stroke.color; ctx.lineWidth = stroke.size; ctx.lineCap = 'round'; ctx.stroke();
                        if (sIdx === strokes.length - 1 && i === stroke.points.length - 1) document.getElementById('replay-status').innerText = "播放結束";
                    }, delay);
                    replayTimeouts.push(t);
                }
                globalOffset += 50; 
            });
        }

        // --- 9. 下載功能 (過濾 ClassCode) ---
        async function downloadAllSubmissions() {
            if (!checkConfig()) return;
            const btn = document.getElementById('btn-download-all');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader w-4 h-4 border-2 !w-4 !h-4"></div> 下載中...`;

            try {
                // 只下載當前班級代碼的作品
                const snap = await db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('submissions')
                                     .where('classCode', '==', currentClassCode).get();
                
                if (snap.empty) { showSystemMessage("無作品"); return; }

                const zip = new JSZip();
                let count = 0;
                const cvs = document.createElement('canvas'); const cCtx = cvs.getContext('2d');
                const loadImage = (src) => new Promise(r => { const i = new Image(); i.onload = () => r(i); i.onerror = () => r(null); i.src = src; });

                for (const doc of snap.docs) {
                    const data = doc.data();
                    const name = (data.name || 'unknown').replace(/[^\w\u4e00-\u9fa5-]/g, '');
                    const pagesToSave = data.pages ? data.pages : [{image: data.image}];

                    for (let i = 0; i < pagesToSave.length; i++) {
                        const pageData = pagesToSave[i];
                        if (!pageData.image) continue;
                        const img = await loadImage(pageData.image);
                        if (img) {
                            cvs.width = img.naturalWidth; cvs.height = img.naturalHeight;
                            cCtx.fillStyle = "#ffffff"; cCtx.fillRect(0, 0, cvs.width, cvs.height); cCtx.drawImage(img, 0, 0);
                            const b64 = cvs.toDataURL('image/png');
                            const blob = await (await fetch(b64)).blob();
                            const suffix = pagesToSave.length > 1 ? `_P${i+1}` : '';
                            zip.file(`${name}${suffix}.png`, blob);
                        }
                    }
                    count++;
                }
                
                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = `Classroom_${currentClassCode}_${new Date().toISOString().slice(0,10)}.zip`;
                a.click();
                showSystemMessage(`已下載 ${count} 位學生的作品`);

            } catch(e) { console.error(e); showSystemMessage("下載錯誤"); } 
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        }

        // --- 10. 背景圖設定功能 ---
        function openBackgroundImageModal() {
            const modal = document.getElementById('modal-background-image');
            const slider = document.getElementById('background-opacity-slider');
            const opacityValue = document.getElementById('opacity-value');

            // 更新滑桿事件
            slider.oninput = function() {
                opacityValue.innerText = this.value + '%';
                updateBackgroundPreview();
            };

            // 檔案選擇事件
            const fileInput = document.getElementById('background-image-input');
            fileInput.onchange = handleBackgroundImageSelect;

            // 重置檔案輸入
            fileInput.value = '';
            document.getElementById('background-preview-container').classList.add('hidden');

            // 添加 Ctrl+V 貼上圖片事件
            document.addEventListener('paste', handlePasteImage);

            modal.classList.remove('hidden');
        }

        function handlePasteImage(e) {
            const modal = document.getElementById('modal-background-image');
            // 只在模態視窗開啟時處理貼上事件
            if (modal.classList.contains('hidden')) return;

            const items = e.clipboardData?.items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('background-preview-img');
                        img.src = event.target.result;
                        document.getElementById('background-preview-container').classList.remove('hidden');
                        updateBackgroundPreview();

                        // 顯示提示
                        showSystemMessage('圖片已貼上', '成功');
                    };
                    reader.readAsDataURL(blob);
                    e.preventDefault();
                    break;
                }
            }
        }

        function handleBackgroundImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showSystemMessage('請選擇圖片檔案');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('background-preview-img');
                img.src = e.target.result;
                document.getElementById('background-preview-container').classList.remove('hidden');
                updateBackgroundPreview();
            };
            reader.readAsDataURL(file);
        }

        function updateBackgroundPreview() {
            const img = document.getElementById('background-preview-img');
            const slider = document.getElementById('background-opacity-slider');
            const opacity = slider.value / 100;
            img.style.opacity = opacity;
        }

        async function saveBackgroundImage() {
            const previewImg = document.getElementById('background-preview-img');
            const slider = document.getElementById('background-opacity-slider');

            // 檢查是否有預覽圖片
            if (!previewImg.src || previewImg.src === '') {
                showSystemMessage('請先選擇或貼上圖片');
                return;
            }

            try {
                const base64Image = previewImg.src;
                const opacity = slider.value / 100;

                // 儲存到 Firebase class_controls
                await db.collection('artifacts').doc(currentAppId)
                        .collection('public').doc('data')
                        .collection('class_controls').doc(currentClassCode)
                        .set({
                            backgroundImage: base64Image,
                            backgroundOpacity: opacity
                        }, { merge: true });

                showSystemMessage('背景圖設定已儲存');
                closeModal('modal-background-image');

                // 移除貼上事件監聽
                document.removeEventListener('paste', handlePasteImage);

            } catch (e) {
                console.error(e);
                showSystemMessage('儲存失敗: ' + e.message);
            }
        }

        function closeBackgroundImageModal() {
            document.removeEventListener('paste', handlePasteImage);
            closeModal('modal-background-image');
        }

        async function removeBackgroundImage() {
            showConfirmationModal('確定要移除背景圖嗎？', async (yes) => {
                if (yes) {
                    try {
                        await db.collection('artifacts').doc(currentAppId)
                                .collection('public').doc('data')
                                .collection('class_controls').doc(currentClassCode)
                                .set({
                                    backgroundImage: null,
                                    backgroundOpacity: null
                                }, { merge: true });

                        showSystemMessage('背景圖已移除');
                        closeBackgroundImageModal();
                    } catch (e) {
                        console.error(e);
                        showSystemMessage('移除失敗: ' + e.message);
                    }
                }
            });
        }

        window.onload = initApp;
    </script>
</body>
</html>